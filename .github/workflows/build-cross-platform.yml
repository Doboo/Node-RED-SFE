# .github/workflows/build.yml
name: 多环境手动打包

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: '构建类型'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development
      version:
        description: '版本号（可选）'
        required: false
        type: string

jobs:
  build:
    name: 构建 ${{ matrix.platform }}-${{ matrix.arch }} 版本
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            pkgTarget: 'node22-win-x64'
          - os: ubuntu-latest
            platform: linux
            arch: x86
            pkgTarget: 'node22-linux-x86'
            extraDeps: 'gcc-multilib g++-multilib'
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            pkgTarget: 'node22-linux-arm64'
            extraDeps: 'gcc-aarch64-linux-gnu g++-aarch64-linux-gnu'
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: 设置Node.js 22.17.1
      uses: actions/setup-node@v4
      with:
        node-version: '22.17.1'
        # 禁用缓存以避免锁文件检查错误
        # cache: 'npm'

    - name: 安装依赖并生成package-lock.json
      run: |
        npm install
        # 确保锁文件存在
        if [ ! -f "package-lock.json" ]; then
          npm install --package-lock-only
        fi
      shell: bash

    - name: 安装架构特定依赖
      if: matrix.extraDeps
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.extraDeps }}
      shell: bash

    - name: 构建项目
      run: npm run build
      env:
        NODE_ENV: ${{ github.event.inputs.buildType }}
        PLATFORM: ${{ matrix.platform }}
        ARCH: ${{ matrix.arch }}
        VERSION: ${{ github.event.inputs.version || github.sha }}

    - name: 跨平台打包
      run: |
        cd ./build
        npx @yao-pkg/pkg@6.2.0 ./package.json --compress gzip --targets ${{ matrix.pkgTarget }} --output ./dist/node-red-sfe-${{ matrix.platform }}-${{ matrix.arch }}
      shell: bash

    - name: 重命名Windows可执行文件
      if: matrix.platform == 'windows'
      run: |
        cd build/dist
        ren node-red-sfe-${{ matrix.platform }}-${{ matrix.arch }} node-red-sfe-${{ matrix.platform }}-${{ matrix.arch }}.exe
      shell: cmd

    - name: 打包构建产物
      run: |
        VERSION="${{ github.event.inputs.version || github.sha }}"
        if [ "${{ matrix.platform }}" = "windows" ]; then
          7z a build-${{ matrix.platform }}-${{ matrix.arch }}-$VERSION.zip ./build/dist/*
        else
          zip -r build-${{ matrix.platform }}-${{ matrix.arch }}-$VERSION.zip ./build/dist/*
        fi
      shell: bash

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform }}-${{ matrix.arch }}
        path: build-${{ matrix.platform }}-${{ matrix.arch }}-*.zip
        retention-days: 90
