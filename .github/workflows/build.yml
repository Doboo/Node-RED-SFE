# 工作流名称
name: 多环境手动打包

# 触发条件：支持手动触发 + 自动触发（可选）
on:
  workflow_dispatch:  # 允许手动触发
    # 可选：添加手动触发时可配置的参数
    inputs:
      buildType:
        description: '构建类型'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development
      version:
        description: '版本号（可选）'
        required: false
        type: string
  # 保留自动触发（可选，根据需要决定是否保留）
  push:
    branches: [ "main" ]

jobs:
  build:
    name: 构建 ${{ matrix.os }}-${{ matrix.arch }} 版本
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: ubuntu-latest
            platform: linux
            arch: arm64
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: 设置Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.17
        cache: 'npm'

    - name: 安装依赖
      run: npm install

    - name: ARM64架构额外依赖
      if: matrix.arch == 'arm64'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
      shell: bash

    - name: 构建项目
      run: npm run build
      env:
        NODE_ENV: ${{ github.event.inputs.buildType }}  # 使用手动输入的构建类型
        PLATFORM: ${{ matrix.platform }}
        ARCH: ${{ matrix.arch }}
        VERSION: ${{ github.event.inputs.version || github.sha }}  # 版本号优先使用手动输入

    - name: 打包构建产物
      run: |
        VERSION="${{ github.event.inputs.version || github.sha }}"
        if [ "${{ matrix.platform }}" = "windows" ]; then
          7z a build-${{ matrix.platform }}-${{ matrix.arch }}-$VERSION.zip ./dist/*
        else
          zip -r build-${{ matrix.platform }}-${{ matrix.arch }}-$VERSION.zip ./dist/*
        fi
      shell: bash

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform }}-${{ matrix.arch }}
        path: build-${{ matrix.platform }}-${{ matrix.arch }}-*.zip
        retention-days: 90
